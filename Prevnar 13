# Read a tab-delimited text file into R as a data frame.
expr_mtx = read.delim("GSE298577_Prevnar.D0.D7.RMA.txt")

#Read the platform (annotation) file, but skips the first 11 lines (usually metadata).
gene_annot = read.delim("GPL13158-5065.txt", skip = 11)

#Keep only columns 1 and 3 from the annotation file.
gene_annot = gene_annot[,c(1,3)]

#Remove rows where the same gene symbol appears more than once, keeping only the first occurrence.
gene_annot = gene_annot[!duplicated(gene_annot$Gene.Symbol),]

#Remove rows where the gene symbol is missing (NA).
gene_annot = gene_annot[!is.na(gene_annot$Gene.Symbol),]

#If a probe maps to multiple genes (separated by "///"), this keeps only the first gene symbol.
gene_annot$Gene.Symbol = unlist(lapply(1:nrow(gene_annot), function(x){strsplit(gene_annot$Gene.Symbol[x], "///")[[1]][1]}))

#Keeps only rows in the expression matrix whose probe IDs are found in the annotation file.
expr_mtx = expr_mtx[expr_mtx$Pset.ID %in% gene_annot$ID, ]

#Merge expression data with gene annotation using probe ID.
expr_mtx = merge(expr_mtx, gene_annot, by.x = "Pset.ID", by.y = "ID")

#Remove duplicated gene symbols in the merged dataset.
expr_mtx = expr_mtx[!duplicated(expr_mtx$Gene.Symbol),]

#Remove any rows without gene symbols.
expr_mtx = expr_mtx[!is.na(expr_mtx$Gene.Symbol),]
rownames(expr_mtx) = expr_mtx$Gene.Symbol

#Drop column 1 (probe ID) and column 84 (the gene symbol column, now redundant).
expr_mtx = expr_mtx[,-c(1,84)]

#Delete gene_annot object from memory.
rm(gene_annot)


